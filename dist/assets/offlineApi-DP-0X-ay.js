import{u as n,a as o,C as J}from"./index-2AF0VSfh.js";import{v as te}from"./utils-vendor-5vCYNseS.js";const K=()=>{const e=new Date,t=e.getTimezoneOffset()*6e4;return new Date(e.getTime()-t).toISOString().slice(0,19).replace("T"," ")},l=()=>{try{return J.isNativePlatform()}catch{return!1}},P=async()=>{if(!l())return!0;try{const e=await n.getServerUrl();return e?(await fetch(`${e}/api/health`,{method:"GET",signal:AbortSignal.timeout(3e3)})).ok:!1}catch{return!1}},V=()=>`OFFLINE_${Date.now()}_${te().slice(0,8)}`,ae={async getAll(){let e=null,t=!1;try{const s=localStorage.getItem("currentUser");if(s){const r=JSON.parse(s);["ADMIN","admin","MANAGER","manager","GENERAL_MANAGER","المدير","المدير العام","مسئول النظام"].includes(r.role)||(["SALESMAN","salesman","SALES","sales","مبيعات","مندوب"].includes(r.role)||r.vehicleId)&&(e=r.salesmanId||r.id,t=!0)}}catch{}if(!l()){const s=await o.get("/vehicles");let r=Array.isArray(s)?s:[];return t&&e&&(r=r.filter(i=>i.salesmanId===e)),r}await n.initialize();let a=await n.getVehicles();return t&&e&&(a=a.filter(s=>s.salesmanId===e)),a},async get(e){if(!l())try{return await o.get(`/vehicles/${e}`)}catch{return null}return(await this.getAll()).find(a=>a.id===e)||null},async getInventory(e){try{await n.initialize();let a=await n.getVehicleInventory(e);if(a.length===0&&await P())try{const s=await o.get(`/vehicles/${e}/inventory`);if(Array.isArray(s)&&s.length>0){for(const r of s)await n.upsertVehicleInventoryItem(e,{productId:String(r.productId),productName:r.productName,quantity:r.quantity||0});return s.map(r=>({id:r.id,vehicleId:r.vehicleId||e,productId:String(r.productId),productName:r.productName,productSku:r.productSku,quantity:r.quantity||0,unitPrice:r.unitPrice||r.price||0,price:r.unitPrice||r.price||0,cost:r.cost||0,totalValue:r.totalValue||0}))}}catch{}if(a.length>0)return a.map(s=>({...s,price:s.unitPrice||s.price||0}))}catch{}const t=await o.get(`/vehicles/${e}/inventory`);return Array.isArray(t)?t:[]},async loadGoods(e,t,a,s){const r={vehicleId:e,operationType:"LOAD",warehouseId:t,items:a,notes:s,date:new Date().toISOString()};if(!l()||await P())try{const c=await o.post(`/vehicles/${e}/load`,{warehouseId:t,items:a,notes:s});return{success:!0,id:c.id||c.operationId,offline:!1}}catch(c){if(!l())throw c}const i=V();return await n.addToPendingSync("vehicle_operation","LOAD",{id:i,...r}),await this._updateLocalInventory(e,a,"add"),{success:!0,id:i,offline:!0,message:"تم حفظ عملية التحميل محلياً - سيتم المزامنة عند الاتصال"}},async unloadGoods(e,t,a,s){if(!l()||await P())try{const i=await o.post(`/vehicles/${e}/unload`,{warehouseId:t,items:a,notes:s});return{success:!0,id:i.id||i.operationId,offline:!1}}catch(i){if(!l())throw i}const r=V();return await n.addToPendingSync("vehicle_operation","UNLOAD",{id:r,vehicleId:e,operationType:"UNLOAD",warehouseId:t,items:a,notes:s,date:new Date().toISOString()}),await this._updateLocalInventory(e,a,"subtract"),{success:!0,id:r,offline:!0,message:"تم حفظ عملية التفريغ محلياً - سيتم المزامنة عند الاتصال"}},async _updateLocalInventory(e,t,a){await n.initialize();const s=await n.getVehicleInventory(e);s.length>0;for(const r of t)try{const i=String(r.productId),c=s.find(f=>String(f.productId)===i);if(c){const f=a==="add"?r.quantity:-r.quantity,A=Math.max(0,(c.quantity||0)+f);await n.updateVehicleInventoryItem(e,i,A)}else a==="add"&&await n.addVehicleInventoryItem(e,{productId:i,productName:r.productName,quantity:r.quantity})}catch{}}},le={async getAll(e){if(!l()){const t=new URLSearchParams;e?.vehicleId&&t.append("vehicleId",e.vehicleId),e?.salesmanId&&t.append("salesmanId",e.salesmanId),e?.date&&t.append("date",e.date),t.append("limit",String(e?.limit||100));const a=await o.get(`/vehicles/visits?${t.toString()}`);return Array.isArray(a)?a:[]}return await n.initialize(),await n.getCustomerVisits(e)},async create(e){if(!l()||await P())try{return{success:!0,id:(await o.post("/vehicles/visits",e)).id,offline:!1}}catch(s){if(!l())throw s}const t=V(),a={id:t,...e};return await n.saveCustomerVisit(a),await n.addToPendingSync("customer_visit","CREATE",a),{success:!0,id:t,offline:!0,message:"تم حفظ الزيارة محلياً"}},async updateResult(e,t,a){if(!l()||await P())try{return await o.put(`/vehicles/visits/${e}`,{result:t,...a}),{success:!0,offline:!1}}catch(s){if(!l())throw s}return await n.updateCustomerVisit(e,{result:t,...a}),await n.addToPendingSync("customer_visit","UPDATE",{id:e,result:t,...a}),{success:!0,offline:!0}},async quickSale(e,t){const a="__quickSaleMutex";if(window[a])try{await window[a]}catch{}let s;window[a]=new Promise(i=>{s=i});const r=()=>{s(),window[a]=null};try{const i=`${t.partnerId}-${t.total}-${Date.now()}`,c=`${t.partnerId}-${t.total}`;if(window.__quickSaleLock?.[c]&&Date.now()-window.__quickSaleLock[c]<3e4)return r(),{success:!1,invoiceId:"",offline:!1,message:"Duplicate sale blocked"};window.__quickSaleLock||(window.__quickSaleLock={}),window.__quickSaleLock[c]=Date.now();const f=async T=>{if(t.vehicleId)for(const M of t.lines)await ae._updateLocalInventory(t.vehicleId,[{productId:M.productId,productName:M.productName,quantity:M.quantity}],"subtract")};!1&&(!l()||await P());const v=V(),D=`INV-${Math.random().toString(36).substr(2,6).toUpperCase()}`,_=e==="return"||t.paymentMethod==="RETURN",k=_?"RETURN_SALE":"INVOICE_SALE",U={id:v,number:D,date:K(),type:k,...t,status:"POSTED"};await n.saveInvoice(U),t.vehicleId?await n.addToPendingSync("van_sale","CREATE",{id:v,vehicleId:t.vehicleId,customerId:t.partnerId,customerName:t.partnerName,items:t.lines.map(T=>({productId:T.productId,productName:T.productName,quantity:T.quantity,price:T.price})),paymentMethod:t.paymentMethod||"CASH",paymentCollected:t.paidAmount||0,discount:t.discount||0,total:t.total,date:K(),isReturn:_,notes:t.notes,bankAccountId:t.bankAccountId,creditPaymentType:t.creditPaymentType}):await n.addToPendingSync("invoice","CREATE",U),await this.updateResult(e,"SALE",{invoiceId:v,invoiceAmount:t.total,paymentCollected:t.paidAmount||0,paymentMethod:t.paymentMethod}),await f(v);try{await n.updatePartnerBalance(t.partnerId,t.total,t.paidAmount||0)}catch{}return r(),{success:!0,invoiceId:v,offline:!0,message:"تم حفظ الفاتورة محلياً"}}catch(i){throw r(),i}}},ue={async getAll(e){if(!l()){const t=e?`?vehicleId=${e}`:"",a=await o.get(`/vehicles/settlements${t}`);return Array.isArray(a)?a:[]}return await n.initialize(),await n.getSettlements(e)},async create(e){if(!l()||await P())try{return{success:!0,id:(await o.post("/vehicles/settlements",e)).id,offline:!1}}catch(s){if(!l())throw s}const t=V(),a={id:t,...e,status:"DRAFT"};return await n.saveSettlement(a),await n.addToPendingSync("vehicle_settlement","CREATE",a),{success:!0,id:t,offline:!0,message:"تم حفظ التسوية محلياً"}},async calculate(e,t,a){if(!l())return await o.get(`/vehicles/${e}/settlement-data?date=${t}`);await n.initialize();let s=null,r=!1;try{const S=(await n.getSettlements(e)).filter(h=>{const I=(h.settlementDate?.slice(0,10)||"")===t,p=h.status==="APPROVED";return I&&p});if(S.length>0){r=!0;const h=S.reduce((g,I)=>{const p=new Date(I.approvedAt||I.updatedAt||I.createdAt||0),y=new Date(g.approvedAt||g.updatedAt||g.createdAt||0);return p>y?I:g});s=new Date(h.approvedAt||h.updatedAt||h.createdAt)}}catch{}const i=await n.getCustomerVisits({vehicleId:e,date:t}),c=s?i.filter(u=>new Date(u.visitDate||u.createdAt||0)>s):i,f=await n.getVehicleInventory(e);let A=0,v=0,B=0,D=0;for(const u of c)if(u.result==="SALE"&&u.invoiceAmount){const S=u.paymentMethod||"",h=S.toUpperCase(),g=h==="CASH"||h==="NAGDY"||S==="نقدي"||S==="نقداً"||S.includes("نقد"),I=h==="BANK"||S.includes("بنك"),p=h==="CREDIT"||S==="آجل"||S.includes("آجل");if(g){const y=u.paymentCollected||u.invoiceAmount||0;A+=y,D+=y}else if(I)B+=u.invoiceAmount;else if(p)v+=u.invoiceAmount,u.paymentCollected&&u.paymentCollected>0&&(D+=u.paymentCollected);else{const y=u.invoiceAmount||0,d=u.paymentCollected||0;d>=y&&y>0?(A+=y,D+=d):(v+=y,d>0&&(D+=d))}}let _=0,k=0,U=0,T=0,M=0,x=0;try{const h=(await n.getVehicles()).find(d=>String(d.id)===String(e))?.salesmanId,g=await n.getInvoices(),I=new Date(t);I.setHours(0,0,0,0);const p=new Date(t);p.setHours(23,59,59,999),g.length>0&&g.slice(0,3).forEach(E=>{});const y=g.filter(d=>{if(!d.date)return!1;const E=new Date(d.date);if(!(E>=I&&E<=p)||s&&E<=s)return!1;if(a){const O=String(d.createdBy||"").toLowerCase(),F=String(d.salesmanId||"").toLowerCase(),$=String(d.salesmanName||"").toLowerCase(),R=a.toLowerCase();if(!(!O&&!F&&!$||O===R||F===R||$===R||O.includes(R)||$.includes(R)))return!1}return!0});for(const d of y){const E=(d.type||"").toUpperCase(),C=d.paymentMethod||"",O=C.toUpperCase(),F=E.includes("SALE")&&!E.includes("RETURN"),$=E.includes("RETURN");if(F){const R=d.total||0,G=d.paidAmount??0,L=d.discount||0,X=O==="CASH"||C==="نقدي"||C==="نقداً",Z=O==="BANK"||C==="بنك"||C==="تحويل",ee=O==="CREDIT"||C==="آجل";if(L>0&&(x+=L),X){const N=R-L;_+=N}else if(Z){const N=R-L;U+=N}else if(ee){const N=R-L;k+=N,G>0&&(M+=G)}else{const N=R-L;k+=N}}else $&&(T+=d.total||0)}}catch{}const b=Math.max(A,_),z=Math.max(v,k),Y=Math.max(B,U);let H=0;try{const u=await n.getInvoices({type:"RECEIPT"}),g=(await n.getVehicles()).find(p=>String(p.id)===String(e))?.salesmanId,I=u.filter(p=>{if(!p.date||!p.date.startsWith(t)||s&&new Date(p.date)<=s)return!1;if(g){const y=String(p.salesmanId||""),d=String(p.createdBy||""),E=String(p.userId||""),C=String(g);return y===C||d===C||E===C}return!0});for(const p of I){const y=(p.paymentMethod||"").toUpperCase();(!y||y==="CASH")&&(H+=p.paidAmount||p.total||0)}}catch{}const q=b+H+M,j=f.reduce((u,S)=>u+((S.quantity||0)*S.unitPrice||0),0);return{vehicleId:e,settlementDate:t,totalCashSales:b,totalCreditSales:z,totalSales:b+z+Y,cashCollected:q,totalCollections:q,closingInventoryValue:j,expectedCash:q-T,actualCash:0,cashDifference:0,totalReturns:T,totalDiscounts:x}}},de={async getAll(e){if(!l()){const t=new URLSearchParams;e?.vehicleId&&t.append("vehicleId",e.vehicleId),e?.salesmanId&&t.append("salesmanId",e.salesmanId),e?.date&&t.append("date",e.date);const a=await o.get(`/vehicles/routes?${t.toString()}`);return Array.isArray(a)?a:[]}return await n.initialize(),await n.getVehicleRoutes(e)},async get(e){if(!l())try{return await o.get(`/vehicles/routes/${e}`)}catch{return null}return await n.initialize(),await n.getVehicleRoute(e)},async create(e){if(!l()||await P())try{return{success:!0,id:(await o.post("/vehicles/routes",e)).id,offline:!1}}catch(s){if(!l())throw s}const t=V(),a={id:t,...e};return await n.saveVehicleRoute(a),await n.addToPendingSync("vehicle_route","CREATE",a),{success:!0,id:t,offline:!0,message:"تم حفظ خط السير محلياً"}},async start(e){const t={status:"IN_PROGRESS",startTime:new Date().toISOString()};if(!l()||await P())try{return await o.put(`/vehicles/routes/${e}/start`,{}),{success:!0,offline:!1}}catch(a){if(!l())throw a}return await n.updateVehicleRoute(e,t),await n.addToPendingSync("vehicle_route","START",{id:e,...t}),{success:!0,offline:!0}},async completeStop(e,t,a){if(!l()||await P())try{return await o.put(`/vehicles/routes/${e}/stops/${t}/complete`,a),{success:!0,offline:!1}}catch(s){if(!l())throw s}return await n.updateRouteStop(e,t,{status:"VISITED",...a}),await n.addToPendingSync("route_stop","COMPLETE",{routeId:e,stopId:t,...a}),{success:!0,offline:!0}},async complete(e){const t={status:"COMPLETED",endTime:new Date().toISOString()};if(!l()||await P())try{return await o.put(`/vehicles/routes/${e}/complete`,{}),{success:!0,offline:!1}}catch(a){if(!l())throw a}return await n.updateVehicleRoute(e,t),await n.addToPendingSync("vehicle_route","COMPLETE",{id:e,...t}),{success:!0,offline:!0}}},w=()=>J.isNativePlatform(),Q=()=>`OFF_${Date.now().toString(36)}${Math.random().toString(36).slice(2,8)}`,W=()=>{try{const e=localStorage.getItem("currentUser");if(!e)return{salesmanId:null,isSalesman:!1};const t=JSON.parse(e);if(["ADMIN","admin","MANAGER","manager","GENERAL_MANAGER","المدير","المدير العام","مسئول النظام"].includes(t.role))return{salesmanId:null,isSalesman:!1};const r=["SALESMAN","salesman","SALES","sales","مبيعات","مندوب"].includes(t.role),i=!!t.vehicleId;return t.salesmanId?{salesmanId:t.salesmanId,isSalesman:!0}:r||i?{salesmanId:t.id,isSalesman:!0}:{salesmanId:null,isSalesman:!1}}catch{return{salesmanId:null,isSalesman:!1}}},m={invoice:(e,t=!1)=>({id:e.id,type:e.type,partnerId:e.partnerId,partnerName:e.partnerName||"",date:e.date,dueDate:e.dueDate,total:parseFloat(e.total)||0,paidAmount:parseFloat(e.paidAmount)||0,status:e.status||"DRAFT",lines:e.lines||[],notes:e.notes,previousBalance:e.previousBalance!=null?parseFloat(e.previousBalance):void 0,newBalance:e.newBalance!=null?parseFloat(e.newBalance):void 0,updatedAt:e.updatedAt||new Date().toISOString(),syncedAt:t?new Date().toISOString():""}),product:(e,t=!1)=>({id:e.id,sku:e.sku||"",name:e.name,categoryId:e.categoryId,categoryName:e.categoryName,price:parseFloat(e.price)||0,cost:parseFloat(e.cost)||0,stock:parseFloat(e.stock)||0,minStock:e.minStock,unit:e.unit,barcode:e.barcode,image:e.image,isActive:e.isActive!==!1,updatedAt:e.updatedAt||new Date().toISOString(),syncedAt:t?new Date().toISOString():""}),partner:(e,t=!1)=>({id:e.id,code:e.code,name:e.name,phone:e.phone,address:e.address,type:e.type||"CUSTOMER",isCustomer:e.isCustomer||e.type==="CUSTOMER"||e.type==="BOTH",isSupplier:e.isSupplier||e.type==="SUPPLIER"||e.type==="BOTH",balance:parseFloat(e.balance)||0,creditLimit:e.creditLimit,priceListId:e.priceListId,salesmanId:e.salesmanId,updatedAt:e.updatedAt||new Date().toISOString(),syncedAt:t?new Date().toISOString():""})},se={async create(e){const t=await n.isOnline(),a=e.id||Q(),s={...e,id:a,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};if(t&&w())try{const i=(await o.syncTransaction({invoice:s})).invoiceId||a;return await n.saveInvoices([{...s,id:i}],new Date().toISOString()),{success:!0,id:i,offline:!1}}catch{return this.saveOffline(s)}else return w()?this.saveOffline(s):{success:!0,id:(await o.syncTransaction({invoice:s})).invoiceId||a,offline:!1}},async saveOffline(e){try{const t=await n.createInvoice(e);return{success:t.success,id:t.id,offline:!0,message:t.success?"تم حفظ الفاتورة محلياً. ستتم المزامنة عند الاتصال بالإنترنت.":"فشل حفظ الفاتورة محلياً"}}catch(t){return{success:!1,id:e.id,offline:!0,message:`فشل الحفظ: ${t.message}`}}},async getAll(e){const{salesmanId:t,isSalesman:a}=W();if(!w()){let c=(await o.getInvoices({limit:e?.limit||100})).invoices.map(f=>m.invoice(f,!0));return a&&t&&(c=c.filter(f=>f.salesmanId===t)),c}const s=await n.getInvoices();let r=s;return a&&t&&(r=s.filter(i=>i.salesmanId===t||i.createdBy===t)),e?.partnerId&&(r=r.filter(i=>i.partnerId===e.partnerId)),e?.limit&&(r=r.slice(0,e.limit)),r.map(i=>m.invoice(i,!!i.syncedAt))},async get(e){if(!w()){const s=await o.getInvoice(e);return m.invoice(s,!0)}const a=(await n.getInvoices()).find(s=>s.id===e);return a?m.invoice(a,!!a.syncedAt):null},async update(e){const t=await n.isOnline();if(e.updatedAt=new Date().toISOString(),t&&w())try{return await o.syncTransaction({invoice:e}),await n.saveInvoices([e],new Date().toISOString()),{success:!0,offline:!1}}catch{return await n.saveInvoices([e],""),await n.addToPendingSync("invoice","UPDATE",e),{success:!0,offline:!0}}else return w()?(await n.saveInvoices([e],""),await n.addToPendingSync("invoice","UPDATE",e),{success:!0,offline:!0}):(await o.syncTransaction({invoice:e}),{success:!0,offline:!1})},async delete(e){const t=await n.isOnline(),a=JSON.parse(localStorage.getItem("currentUser")||"{}").name||"System";if(t&&w())try{return await o.syncTransaction({deletedInvoiceId:e,user:a}),{success:!0,offline:!1}}catch{return await n.addToPendingSync("invoice","DELETE",{id:e,user:a}),{success:!0,offline:!0}}else return w()?(await n.addToPendingSync("invoice","DELETE",{id:e,user:a}),{success:!0,offline:!0}):(await o.syncTransaction({deletedInvoiceId:e,user:a}),{success:!0,offline:!1})},async getPendingCount(){return w()?await n.getPendingCount():0}},ne={async getAll(){return w()?(await n.getProducts()).map(t=>m.product(t,!0)):(await o.getProducts()).map(a=>m.product(a,!0))},async search(e,t=50){return w()?(await n.searchProducts(e,t)).map(s=>m.product(s,!0)):(await o.getProductsPaginated(1,t,e)).products.map(r=>m.product(r,!0))},async get(e){if(!w()){const s=await o.getProduct(e);return m.product(s,!0)}const a=(await n.getProducts()).find(s=>s.id===e);return a?m.product(a,!0):null},async getByBarcode(e){if(!w())try{const s=await o.getUnitByBarcode(e);return m.product(s,!0)}catch{return null}const a=(await n.getProducts()).find(s=>s.barcode===e);return a?m.product(a,!0):null}},re={async getAll(e){const{salesmanId:t,isSalesman:a}=W();if(!w()){let c=(await o.getPartners({limit:1e3,type:e})).partners.map(f=>m.partner(f,!0));if(a&&t&&e==="CUSTOMER"){const f=String(t),A=c.filter(v=>v.salesmanId&&String(v.salesmanId)===f);return A.length>0?A:c}return c}const s=await n.getPartners();let r=s;if(e==="CUSTOMER"?r=s.filter(i=>i.isCustomer):e==="SUPPLIER"&&(r=s.filter(i=>i.isSupplier)),a&&t&&e==="CUSTOMER"){const i=String(t),c=r.filter(f=>{const A=f.salesmanId;return A&&String(A)===i});if(c.length>0)return c.map(f=>m.partner(f,!0))}return r.map(i=>m.partner(i,!0))},async search(e,t,a=50){if(!w())return(await o.getPartners({limit:a,search:e,type:t})).partners.map(f=>m.partner(f,!0));const s=await n.getPartners(),r=e.toLowerCase();let i=s.filter(c=>c.name.toLowerCase().includes(r)||c.phone&&c.phone.includes(e)||c.code&&c.code.toLowerCase().includes(r));return t==="CUSTOMER"?i=i.filter(c=>c.isCustomer):t==="SUPPLIER"&&(i=i.filter(c=>c.isSupplier)),i.slice(0,a).map(c=>m.partner(c,!0))},async get(e){if(!w()){const s=await o.getPartners({limit:1,search:e});return s.partners.length>0?m.partner(s.partners[0],!0):null}const a=(await n.getPartners()).find(s=>s.id===e);return a?m.partner(a,!0):null},async create(e){const t=await n.isOnline(),a=e.id||Q(),s={...e,id:a};if(t&&w())try{const r=await o.createPartner(s);return await n.savePartners([r],new Date().toISOString()),{success:!0,id:r.id,offline:!1}}catch{return await n.savePartners([s],""),await n.addToPendingSync("partner","CREATE",s),{success:!0,id:a,offline:!0}}else return w()?(await n.savePartners([s],""),await n.addToPendingSync("partner","CREATE",s),{success:!0,id:a,offline:!0}):{success:!0,id:(await o.createPartner(s)).id,offline:!1}}},ie={async getStatus(){const e=await n.getStats(),t=await n.getPendingCount();return{isOnline:await n.isOnline(),pendingCount:t,lastSync:e.lastSync,stats:{products:e.products,partners:e.partners,invoices:e.invoices}}},async fullSync(){const e=await n.downloadAllData();return{success:e.success,message:e.message}},async deltaSync(){const e=await n.downloadAllData();return{success:e.success,message:e.message}},async syncPending(){return await n.syncPendingOperations()},async getPendingOperations(){return await n.getPendingOperations()},onSyncEvent(e){return()=>{}}},fe={invoice:se,product:ne,partner:re,sync:ie};export{fe as a,ae as b,le as c,ue as d,de as o};
