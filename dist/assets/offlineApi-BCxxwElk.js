import{u as n,a as l,C as Y}from"./index-DYLume9J.js";import{v as se}from"./utils-vendor-5vCYNseS.js";const Q=()=>{const e=new Date,t=e.getTimezoneOffset()*6e4;return new Date(e.getTime()-t).toISOString().slice(0,19).replace("T"," ")},u=()=>{try{return Y.isNativePlatform()}catch{return!1}},T=async()=>{if(!u())return!0;try{const e=await n.getServerUrl();return e?(await fetch(`${e}/api/health`,{method:"GET",signal:AbortSignal.timeout(3e3)})).ok:!1}catch{return!1}},M=()=>`OFFLINE_${Date.now()}_${se().slice(0,8)}`,ne={async getAll(){let e=null,t=!1;try{const s=localStorage.getItem("currentUser");if(s){const r=JSON.parse(s);["ADMIN","admin","MANAGER","manager","GENERAL_MANAGER","المدير","المدير العام","مسئول النظام"].includes(r.role)||(["SALESMAN","salesman","SALES","sales","مبيعات","مندوب"].includes(r.role)||r.vehicleId)&&(e=r.salesmanId||r.id,t=!0)}}catch{}if(!u()){const s=await l.get("/vehicles");let r=Array.isArray(s)?s:[];return t&&e&&(r=r.filter(i=>i.salesmanId===e)),r}await n.initialize();let a=await n.getVehicles();return t&&e&&(a=a.filter(s=>s.salesmanId===e)),a},async get(e){if(!u())try{return await l.get(`/vehicles/${e}`)}catch{return null}return(await this.getAll()).find(a=>a.id===e)||null},async getInventory(e){try{await n.initialize();let a=await n.getVehicleInventory(e);if(a.length===0&&await T())try{const s=await l.get(`/vehicles/${e}/inventory`);if(Array.isArray(s)&&s.length>0){for(const r of s)await n.upsertVehicleInventoryItem(e,{productId:String(r.productId),productName:r.productName,quantity:r.quantity||0});return s.map(r=>({id:r.id,vehicleId:r.vehicleId||e,productId:String(r.productId),productName:r.productName,productSku:r.productSku,quantity:r.quantity||0,unitPrice:r.unitPrice||r.price||0,price:r.unitPrice||r.price||0,cost:r.cost||0,totalValue:r.totalValue||0}))}}catch{}if(a.length>0)return a.map(s=>({...s,price:s.unitPrice||s.price||0}))}catch{}const t=await l.get(`/vehicles/${e}/inventory`);return Array.isArray(t)?t:[]},async loadGoods(e,t,a,s){const r={vehicleId:e,operationType:"LOAD",warehouseId:t,items:a,notes:s,date:new Date().toISOString()};if(!u()||await T())try{const o=await l.post(`/vehicles/${e}/load`,{warehouseId:t,items:a,notes:s});return{success:!0,id:o.id||o.operationId,offline:!1}}catch(o){if(!u())throw o}const i=M();return await n.addToPendingSync("vehicle_operation","LOAD",{id:i,...r}),await this._updateLocalInventory(e,a,"add"),{success:!0,id:i,offline:!0,message:"تم حفظ عملية التحميل محلياً - سيتم المزامنة عند الاتصال"}},async unloadGoods(e,t,a,s){if(!u()||await T())try{const i=await l.post(`/vehicles/${e}/unload`,{warehouseId:t,items:a,notes:s});return{success:!0,id:i.id||i.operationId,offline:!1}}catch(i){if(!u())throw i}const r=M();return await n.addToPendingSync("vehicle_operation","UNLOAD",{id:r,vehicleId:e,operationType:"UNLOAD",warehouseId:t,items:a,notes:s,date:new Date().toISOString()}),await this._updateLocalInventory(e,a,"subtract"),{success:!0,id:r,offline:!0,message:"تم حفظ عملية التفريغ محلياً - سيتم المزامنة عند الاتصال"}},async _updateLocalInventory(e,t,a){await n.initialize();const s=await n.getVehicleInventory(e);s.length>0;for(const r of t)try{const i=String(r.productId),o=s.find(f=>String(f.productId)===i);if(o){const f=a==="add"?r.quantity:-r.quantity,I=Math.max(0,(o.quantity||0)+f);await n.updateVehicleInventoryItem(e,i,I)}else a==="add"&&await n.addVehicleInventoryItem(e,{productId:i,productName:r.productName,quantity:r.quantity})}catch{}}},de={async getAll(e){if(!u()){const t=new URLSearchParams;e?.vehicleId&&t.append("vehicleId",e.vehicleId),e?.salesmanId&&t.append("salesmanId",e.salesmanId),e?.date&&t.append("date",e.date),t.append("limit",String(e?.limit||100));const a=await l.get(`/vehicles/visits?${t.toString()}`);return Array.isArray(a)?a:[]}return await n.initialize(),await n.getCustomerVisits(e)},async create(e){if(!u()||await T())try{return{success:!0,id:(await l.post("/vehicles/visits",e)).id,offline:!1}}catch(s){if(!u())throw s}const t=M(),a={id:t,...e};return await n.saveCustomerVisit(a),await n.addToPendingSync("customer_visit","CREATE",a),{success:!0,id:t,offline:!0,message:"تم حفظ الزيارة محلياً"}},async updateResult(e,t,a){if(!u()||await T())try{return await l.put(`/vehicles/visits/${e}`,{result:t,...a}),{success:!0,offline:!1}}catch(s){if(!u())throw s}return await n.updateCustomerVisit(e,{result:t,...a}),await n.addToPendingSync("customer_visit","UPDATE",{id:e,result:t,...a}),{success:!0,offline:!0}},async quickSale(e,t){const a="__quickSaleMutex";if(window[a])try{await window[a]}catch{}let s;window[a]=new Promise(i=>{s=i});const r=()=>{s(),window[a]=null};try{const i=`${t.partnerId}-${t.total}-${Date.now()}`,o=`${t.partnerId}-${t.total}`;if(window.__quickSaleLock?.[o]&&Date.now()-window.__quickSaleLock[o]<3e4)return r(),{success:!1,invoiceId:"",offline:!1,message:"Duplicate sale blocked"};window.__quickSaleLock||(window.__quickSaleLock={}),window.__quickSaleLock[o]=Date.now();const f=async E=>{if(t.vehicleId)for(const O of t.lines)await ne._updateLocalInventory(t.vehicleId,[{productId:O.productId,productName:O.productName,quantity:O.quantity}],"subtract")};!1&&(!u()||await T());const A=M(),N=`INV-${Math.random().toString(36).substr(2,6).toUpperCase()}`,k=e==="return"||t.paymentMethod==="RETURN",F=k?"RETURN_SALE":"INVOICE_SALE",D={id:A,number:N,date:Q(),type:F,...t,status:"POSTED"};await n.saveInvoice(D),t.vehicleId?await n.addToPendingSync("van_sale","CREATE",{id:A,vehicleId:t.vehicleId,customerId:t.partnerId,customerName:t.partnerName,items:t.lines.map(E=>({productId:E.productId,productName:E.productName,quantity:E.quantity,price:E.price})),paymentMethod:t.paymentMethod||"CASH",paymentCollected:t.paidAmount||0,discount:t.discount||0,total:t.total,date:Q(),isReturn:k,notes:t.notes,bankAccountId:t.bankAccountId,creditPaymentType:t.creditPaymentType}):await n.addToPendingSync("invoice","CREATE",D),await this.updateResult(e,"SALE",{invoiceId:A,invoiceAmount:t.total,paymentCollected:t.paidAmount||0,paymentMethod:t.paymentMethod}),await f(A);try{await n.updatePartnerBalance(t.partnerId,t.total,t.paidAmount||0)}catch{}return r(),{success:!0,invoiceId:A,offline:!0,message:"تم حفظ الفاتورة محلياً"}}catch(i){throw r(),i}}},fe={async getAll(e){if(!u()){const t=e?`?vehicleId=${e}`:"",a=await l.get(`/vehicles/settlements${t}`);return Array.isArray(a)?a:[]}return await n.initialize(),await n.getSettlements(e)},async create(e){if(!u()||await T())try{return{success:!0,id:(await l.post("/vehicles/settlements",e)).id,offline:!1}}catch(s){if(!u())throw s}const t=M(),a={id:t,...e,status:"DRAFT"};return await n.saveSettlement(a),await n.addToPendingSync("vehicle_settlement","CREATE",a),{success:!0,id:t,offline:!0,message:"تم حفظ التسوية محلياً"}},async calculate(e,t,a){if(!u())return await l.get(`/vehicles/${e}/settlement-data?date=${t}`);await n.initialize();let s=null,r=!1;try{const w=(await n.getSettlements(e)).filter(v=>v.status==="APPROVED");if(w.length>0){r=!0;const v=w.reduce((g,R)=>{const U=new Date(R.approvedAt||R.updatedAt||R.createdAt||0),S=new Date(g.approvedAt||g.updatedAt||g.createdAt||0);return U>S?R:g});s=new Date(v.approvedAt||v.updatedAt||v.createdAt)}}catch{}const i=await n.getCustomerVisits({vehicleId:e,date:t}),o=s?i.filter(d=>new Date(d.visitDate||d.createdAt||0)>s):i,f=await n.getVehicleInventory(e);let I=0,A=0,b=0,N=0,k=0;for(const d of o)if(d.result==="SALE"&&d.invoiceAmount){const w=d.paymentMethod||"",v=w.toUpperCase(),g=v==="CASH"||v==="NAGDY"||w==="نقدي"||w==="نقداً"||w.includes("نقد"),R=v==="BANK"||w.includes("بنك"),U=v==="CREDIT"||w==="آجل"||w.includes("آجل");if(g){const S=d.paymentCollected||d.invoiceAmount||0;I+=S,N+=S;const c=(d.invoiceAmount||0)-S;c>0&&(k+=c)}else if(R)b+=d.invoiceAmount;else if(U)A+=d.invoiceAmount,d.paymentCollected&&d.paymentCollected>0&&(N+=d.paymentCollected);else{const S=d.invoiceAmount||0,c=d.paymentCollected||0;c>=S&&S>0?(I+=S,N+=c):(A+=S,c>0&&(N+=c))}}let F=0,D=0,E=0,O=0,B=0,q=0;try{const v=(await n.getVehicles()).find(c=>String(c.id)===String(e))?.salesmanId,g=await n.getInvoices();new Date(t).setHours(0,0,0,0),new Date(t).setHours(23,59,59,999),g.length>0&&g.slice(0,3).forEach(y=>{});const S=g.filter(c=>{if(!c.date||s&&c.createdAt&&new Date(c.createdAt)<=s)return!1;if(a){const y=String(c.createdBy||"").toLowerCase(),h=String(c.salesmanId||"").toLowerCase(),P=String(c.salesmanName||"").toLowerCase(),C=a.toLowerCase();if(!(!y&&!h&&!P||y===C||h===C||P===C||y.includes(C)||P.includes(C)))return!1}return!0});for(const c of S){const y=(c.type||"").toUpperCase(),h=c.paymentMethod||"",P=h.toUpperCase(),C=y.includes("SALE")&&!y.includes("RETURN"),K=y.includes("RETURN");if(C){const $=c.total||0,J=c.paidAmount??0,V=Number(c.discount||0)+Number(c.globalDiscount||0),ee=P==="CASH"||h==="نقدي"||h==="نقداً",te=P==="BANK"||h==="بنك"||h==="تحويل",ae=P==="CREDIT"||h==="آجل";if(V>0&&(q+=V),ee){const L=$-V;F+=L}else if(te){const L=$-V;E+=L}else if(ae){const L=$-V;D+=L,J>0&&(B+=J)}else{const L=$-V;D+=L}}else K&&(O+=c.total||0)}}catch{}const _=Math.max(I,F),G=Math.max(A,D),x=Math.max(b,E),X=Math.max(k,q);let H=0;try{const d=await n.getInvoices({type:"RECEIPT"}),g=(await n.getVehicles()).find(c=>String(c.id)===String(e))?.salesmanId;new Date(t).setHours(0,0,0,0),new Date(t).setHours(23,59,59,999);const S=d.filter(c=>{if(!c.date||c.referenceInvoiceId||s&&c.createdAt&&new Date(c.createdAt)<=s)return!1;if(g){const y=String(c.salesmanId||""),h=String(c.createdBy||""),P=String(c.userId||""),C=String(g);return y===C||h===C||P===C}return!0});for(const c of S){const y=(c.paymentMethod||"").toUpperCase();if(!y||y==="CASH"){const h=c.paidAmount||c.total||0;H+=h}}}catch{}const z=H,Z=f.reduce((d,w)=>d+((w.quantity||0)*w.unitPrice||0),0);return{vehicleId:e,settlementDate:t,totalCashSales:_,totalCreditSales:G,totalBankTransfers:x,totalSales:_+G+x,cashCollected:_+B,totalCollections:_+B,totalDebtCollected:z,closingInventoryValue:Z,expectedCash:_+B+z-O,actualCash:0,cashDifference:0,totalReturns:O,totalDiscounts:X}}},pe={async getAll(e){if(!u()){const t=new URLSearchParams;e?.vehicleId&&t.append("vehicleId",e.vehicleId),e?.salesmanId&&t.append("salesmanId",e.salesmanId),e?.date&&t.append("date",e.date);const a=await l.get(`/vehicles/routes?${t.toString()}`);return Array.isArray(a)?a:[]}return await n.initialize(),await n.getVehicleRoutes(e)},async get(e){if(!u())try{return await l.get(`/vehicles/routes/${e}`)}catch{return null}return await n.initialize(),await n.getVehicleRoute(e)},async create(e){if(!u()||await T())try{return{success:!0,id:(await l.post("/vehicles/routes",e)).id,offline:!1}}catch(s){if(!u())throw s}const t=M(),a={id:t,...e};return await n.saveVehicleRoute(a),await n.addToPendingSync("vehicle_route","CREATE",a),{success:!0,id:t,offline:!0,message:"تم حفظ خط السير محلياً"}},async start(e){const t={status:"IN_PROGRESS",startTime:new Date().toISOString()};if(!u()||await T())try{return await l.put(`/vehicles/routes/${e}/start`,{}),{success:!0,offline:!1}}catch(a){if(!u())throw a}return await n.updateVehicleRoute(e,t),await n.addToPendingSync("vehicle_route","START",{id:e,...t}),{success:!0,offline:!0}},async completeStop(e,t,a){if(!u()||await T())try{return await l.put(`/vehicles/routes/${e}/stops/${t}/complete`,a),{success:!0,offline:!1}}catch(s){if(!u())throw s}return await n.updateRouteStop(e,t,{status:"VISITED",...a}),await n.addToPendingSync("route_stop","COMPLETE",{routeId:e,stopId:t,...a}),{success:!0,offline:!0}},async complete(e){const t={status:"COMPLETED",endTime:new Date().toISOString()};if(!u()||await T())try{return await l.put(`/vehicles/routes/${e}/complete`,{}),{success:!0,offline:!1}}catch(a){if(!u())throw a}return await n.updateVehicleRoute(e,t),await n.addToPendingSync("vehicle_route","COMPLETE",{id:e,...t}),{success:!0,offline:!0}}},m=()=>Y.isNativePlatform(),j=()=>`OFF_${Date.now().toString(36)}${Math.random().toString(36).slice(2,8)}`,W=()=>{try{const e=localStorage.getItem("currentUser");if(!e)return{salesmanId:null,isSalesman:!1};const t=JSON.parse(e);if(["ADMIN","admin","MANAGER","manager","GENERAL_MANAGER","المدير","المدير العام","مسئول النظام"].includes(t.role))return{salesmanId:null,isSalesman:!1};const r=["SALESMAN","salesman","SALES","sales","مبيعات","مندوب"].includes(t.role),i=!!t.vehicleId;return t.salesmanId?{salesmanId:t.salesmanId,isSalesman:!0}:r||i?{salesmanId:t.id,isSalesman:!0}:{salesmanId:null,isSalesman:!1}}catch{return{salesmanId:null,isSalesman:!1}}},p={invoice:(e,t=!1)=>({id:e.id,type:e.type,partnerId:e.partnerId,partnerName:e.partnerName||"",date:e.date,dueDate:e.dueDate,total:parseFloat(e.total)||0,paidAmount:parseFloat(e.paidAmount)||0,status:e.status||"DRAFT",lines:e.lines||[],notes:e.notes,previousBalance:e.previousBalance!=null?parseFloat(e.previousBalance):void 0,newBalance:e.newBalance!=null?parseFloat(e.newBalance):void 0,updatedAt:e.updatedAt||new Date().toISOString(),syncedAt:t?new Date().toISOString():""}),product:(e,t=!1)=>({id:e.id,sku:e.sku||"",name:e.name,categoryId:e.categoryId,categoryName:e.categoryName,price:parseFloat(e.price)||0,cost:parseFloat(e.cost)||0,stock:parseFloat(e.stock)||0,minStock:e.minStock,unit:e.unit,barcode:e.barcode,image:e.image,isActive:e.isActive!==!1,updatedAt:e.updatedAt||new Date().toISOString(),syncedAt:t?new Date().toISOString():""}),partner:(e,t=!1)=>({id:e.id,code:e.code,name:e.name,phone:e.phone,address:e.address,type:e.type||"CUSTOMER",isCustomer:e.isCustomer||e.type==="CUSTOMER"||e.type==="BOTH",isSupplier:e.isSupplier||e.type==="SUPPLIER"||e.type==="BOTH",balance:parseFloat(e.balance)||0,creditLimit:e.creditLimit,priceListId:e.priceListId,salesmanId:e.salesmanId,updatedAt:e.updatedAt||new Date().toISOString(),syncedAt:t?new Date().toISOString():""})},re={async create(e){const t=await n.isOnline(),a=e.id||j(),s={...e,id:a,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};if(t&&m())try{const i=(await l.syncTransaction({invoice:s})).invoiceId||a;return await n.saveInvoices([{...s,id:i}],new Date().toISOString()),{success:!0,id:i,offline:!1}}catch{return this.saveOffline(s)}else return m()?this.saveOffline(s):{success:!0,id:(await l.syncTransaction({invoice:s})).invoiceId||a,offline:!1}},async saveOffline(e){try{const t=await n.createInvoice(e);return{success:t.success,id:t.id,offline:!0,message:t.success?"تم حفظ الفاتورة محلياً. ستتم المزامنة عند الاتصال بالإنترنت.":"فشل حفظ الفاتورة محلياً"}}catch(t){return{success:!1,id:e.id,offline:!0,message:`فشل الحفظ: ${t.message}`}}},async getAll(e){const{salesmanId:t,isSalesman:a}=W();if(!m()){let o=(await l.getInvoices({limit:e?.limit||100})).invoices.map(f=>p.invoice(f,!0));return a&&t&&(o=o.filter(f=>f.salesmanId===t)),o}const s=await n.getInvoices();let r=s;return a&&t&&(r=s.filter(i=>i.salesmanId===t||i.createdBy===t)),e?.partnerId&&(r=r.filter(i=>i.partnerId===e.partnerId)),e?.limit&&(r=r.slice(0,e.limit)),r.map(i=>p.invoice(i,!!i.syncedAt))},async get(e){if(!m()){const s=await l.getInvoice(e);return p.invoice(s,!0)}const a=(await n.getInvoices()).find(s=>s.id===e);return a?p.invoice(a,!!a.syncedAt):null},async update(e){const t=await n.isOnline();if(e.updatedAt=new Date().toISOString(),t&&m())try{return await l.syncTransaction({invoice:e}),await n.saveInvoices([e],new Date().toISOString()),{success:!0,offline:!1}}catch{return await n.saveInvoices([e],""),await n.addToPendingSync("invoice","UPDATE",e),{success:!0,offline:!0}}else return m()?(await n.saveInvoices([e],""),await n.addToPendingSync("invoice","UPDATE",e),{success:!0,offline:!0}):(await l.syncTransaction({invoice:e}),{success:!0,offline:!1})},async delete(e){const t=await n.isOnline(),a=JSON.parse(localStorage.getItem("currentUser")||"{}").name||"System";if(t&&m())try{return await l.syncTransaction({deletedInvoiceId:e,user:a}),{success:!0,offline:!1}}catch{return await n.addToPendingSync("invoice","DELETE",{id:e,user:a}),{success:!0,offline:!0}}else return m()?(await n.addToPendingSync("invoice","DELETE",{id:e,user:a}),{success:!0,offline:!0}):(await l.syncTransaction({deletedInvoiceId:e,user:a}),{success:!0,offline:!1})},async getPendingCount(){return m()?await n.getPendingCount():0}},ie={async getAll(){return m()?(await n.getProducts()).map(t=>p.product(t,!0)):(await l.getProducts()).map(a=>p.product(a,!0))},async search(e,t=50){return m()?(await n.searchProducts(e,t)).map(s=>p.product(s,!0)):(await l.getProductsPaginated(1,t,e)).products.map(r=>p.product(r,!0))},async get(e){if(!m()){const s=await l.getProduct(e);return p.product(s,!0)}const a=(await n.getProducts()).find(s=>s.id===e);return a?p.product(a,!0):null},async getByBarcode(e){if(!m())try{const s=await l.getUnitByBarcode(e);return p.product(s,!0)}catch{return null}const a=(await n.getProducts()).find(s=>s.barcode===e);return a?p.product(a,!0):null}},ce={async getAll(e){const{salesmanId:t,isSalesman:a}=W();if(!m()){let o=(await l.getPartners({limit:1e3,type:e})).partners.map(f=>p.partner(f,!0));if(a&&t&&e==="CUSTOMER"){const f=String(t),I=o.filter(A=>A.salesmanId&&String(A.salesmanId)===f);return I.length>0?I:o}return o}const s=await n.getPartners();let r=s;if(e==="CUSTOMER"?r=s.filter(i=>i.isCustomer):e==="SUPPLIER"&&(r=s.filter(i=>i.isSupplier)),a&&t&&e==="CUSTOMER"){const i=String(t),o=r.filter(f=>{const I=f.salesmanId;return I&&String(I)===i});if(o.length>0)return o.map(f=>p.partner(f,!0))}return r.map(i=>p.partner(i,!0))},async search(e,t,a=50){if(!m())return(await l.getPartners({limit:a,search:e,type:t})).partners.map(f=>p.partner(f,!0));const s=await n.getPartners(),r=e.toLowerCase();let i=s.filter(o=>o.name.toLowerCase().includes(r)||o.phone&&o.phone.includes(e)||o.code&&o.code.toLowerCase().includes(r));return t==="CUSTOMER"?i=i.filter(o=>o.isCustomer):t==="SUPPLIER"&&(i=i.filter(o=>o.isSupplier)),i.slice(0,a).map(o=>p.partner(o,!0))},async get(e){if(!m()){const s=await l.getPartners({limit:1,search:e});return s.partners.length>0?p.partner(s.partners[0],!0):null}const a=(await n.getPartners()).find(s=>s.id===e);return a?p.partner(a,!0):null},async create(e){const t=await n.isOnline(),a=e.id||j(),s={...e,id:a};if(t&&m())try{const r=await l.createPartner(s);return await n.savePartners([r],new Date().toISOString()),{success:!0,id:r.id,offline:!1}}catch{return await n.savePartners([s],""),await n.addToPendingSync("partner","CREATE",s),{success:!0,id:a,offline:!0}}else return m()?(await n.savePartners([s],""),await n.addToPendingSync("partner","CREATE",s),{success:!0,id:a,offline:!0}):{success:!0,id:(await l.createPartner(s)).id,offline:!1}}},oe={async getStatus(){const e=await n.getStats(),t=await n.getPendingCount();return{isOnline:await n.isOnline(),pendingCount:t,lastSync:e.lastSync,stats:{products:e.products,partners:e.partners,invoices:e.invoices}}},async fullSync(){const e=await n.downloadAllData();return{success:e.success,message:e.message}},async deltaSync(){const e=await n.downloadAllData();return{success:e.success,message:e.message}},async syncPending(){return await n.syncPendingOperations()},async getPendingOperations(){return await n.getPendingOperations()},onSyncEvent(e){return()=>{}}},me={invoice:re,product:ie,partner:ce,sync:oe};export{me as a,ne as b,de as c,fe as d,pe as o};
