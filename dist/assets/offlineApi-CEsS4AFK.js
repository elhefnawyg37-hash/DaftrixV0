import{u as n,a as l,C as Q}from"./index-ClLebFGB.js";import{v as se}from"./utils-vendor-5vCYNseS.js";const J=()=>{const e=new Date,t=e.getTimezoneOffset()*6e4;return new Date(e.getTime()-t).toISOString().slice(0,19).replace("T"," ")},u=()=>{try{return Q.isNativePlatform()}catch{return!1}},T=async()=>{if(!u())return!0;try{const e=await n.getServerUrl();return e?(await fetch(`${e}/api/health`,{method:"GET",signal:AbortSignal.timeout(3e3)})).ok:!1}catch{return!1}},U=()=>`OFFLINE_${Date.now()}_${se().slice(0,8)}`,ne={async getAll(){let e=null,t=!1;try{const s=localStorage.getItem("currentUser");if(s){const r=JSON.parse(s);["ADMIN","admin","MANAGER","manager","GENERAL_MANAGER","المدير","المدير العام","مسئول النظام"].includes(r.role)||(["SALESMAN","salesman","SALES","sales","مبيعات","مندوب"].includes(r.role)||r.vehicleId)&&(e=r.salesmanId||r.id,t=!0)}}catch{}if(!u()){const s=await l.get("/vehicles");let r=Array.isArray(s)?s:[];return t&&e&&(r=r.filter(i=>i.salesmanId===e)),r}await n.initialize();let a=await n.getVehicles();return t&&e&&(a=a.filter(s=>s.salesmanId===e)),a},async get(e){if(!u())try{return await l.get(`/vehicles/${e}`)}catch{return null}return(await this.getAll()).find(a=>a.id===e)||null},async getInventory(e){try{await n.initialize();let a=await n.getVehicleInventory(e);if(a.length===0&&await T())try{const s=await l.get(`/vehicles/${e}/inventory`);if(Array.isArray(s)&&s.length>0){for(const r of s)await n.upsertVehicleInventoryItem(e,{productId:String(r.productId),productName:r.productName,quantity:r.quantity||0});return s.map(r=>({id:r.id,vehicleId:r.vehicleId||e,productId:String(r.productId),productName:r.productName,productSku:r.productSku,quantity:r.quantity||0,unitPrice:r.unitPrice||r.price||0,price:r.unitPrice||r.price||0,cost:r.cost||0,totalValue:r.totalValue||0}))}}catch{}if(a.length>0)return a.map(s=>({...s,price:s.unitPrice||s.price||0}))}catch{}const t=await l.get(`/vehicles/${e}/inventory`);return Array.isArray(t)?t:[]},async loadGoods(e,t,a,s){const r={vehicleId:e,operationType:"LOAD",warehouseId:t,items:a,notes:s,date:new Date().toISOString()};if(!u()||await T())try{const c=await l.post(`/vehicles/${e}/load`,{warehouseId:t,items:a,notes:s});return{success:!0,id:c.id||c.operationId,offline:!1}}catch(c){if(!u())throw c}const i=U();return await n.addToPendingSync("vehicle_operation","LOAD",{id:i,...r}),await this._updateLocalInventory(e,a,"add"),{success:!0,id:i,offline:!0,message:"تم حفظ عملية التحميل محلياً - سيتم المزامنة عند الاتصال"}},async unloadGoods(e,t,a,s){if(!u()||await T())try{const i=await l.post(`/vehicles/${e}/unload`,{warehouseId:t,items:a,notes:s});return{success:!0,id:i.id||i.operationId,offline:!1}}catch(i){if(!u())throw i}const r=U();return await n.addToPendingSync("vehicle_operation","UNLOAD",{id:r,vehicleId:e,operationType:"UNLOAD",warehouseId:t,items:a,notes:s,date:new Date().toISOString()}),await this._updateLocalInventory(e,a,"subtract"),{success:!0,id:r,offline:!0,message:"تم حفظ عملية التفريغ محلياً - سيتم المزامنة عند الاتصال"}},async _updateLocalInventory(e,t,a){await n.initialize();const s=await n.getVehicleInventory(e);s.length>0;for(const r of t)try{const i=String(r.productId),c=s.find(f=>String(f.productId)===i);if(c){const f=a==="add"?r.quantity:-r.quantity,I=Math.max(0,(c.quantity||0)+f);await n.updateVehicleInventoryItem(e,i,I)}else a==="add"&&await n.addVehicleInventoryItem(e,{productId:i,productName:r.productName,quantity:r.quantity})}catch{}}},de={async getAll(e){if(!u()){const t=new URLSearchParams;e?.vehicleId&&t.append("vehicleId",e.vehicleId),e?.salesmanId&&t.append("salesmanId",e.salesmanId),e?.date&&t.append("date",e.date),t.append("limit",String(e?.limit||100));const a=await l.get(`/vehicles/visits?${t.toString()}`);return Array.isArray(a)?a:[]}return await n.initialize(),await n.getCustomerVisits(e)},async create(e){if(!u()||await T())try{return{success:!0,id:(await l.post("/vehicles/visits",e)).id,offline:!1}}catch(s){if(!u())throw s}const t=U(),a={id:t,...e};return await n.saveCustomerVisit(a),await n.addToPendingSync("customer_visit","CREATE",a),{success:!0,id:t,offline:!0,message:"تم حفظ الزيارة محلياً"}},async updateResult(e,t,a){if(!u()||await T())try{return await l.put(`/vehicles/visits/${e}`,{result:t,...a}),{success:!0,offline:!1}}catch(s){if(!u())throw s}return await n.updateCustomerVisit(e,{result:t,...a}),await n.addToPendingSync("customer_visit","UPDATE",{id:e,result:t,...a}),{success:!0,offline:!0}},async quickSale(e,t){const a="__quickSaleMutex";if(window[a])try{await window[a]}catch{}let s;window[a]=new Promise(i=>{s=i});const r=()=>{s(),window[a]=null};try{const i=`${t.partnerId}-${t.total}-${Date.now()}`,c=`${t.partnerId}-${t.total}`;if(window.__quickSaleLock?.[c]&&Date.now()-window.__quickSaleLock[c]<3e4)return r(),{success:!1,invoiceId:"",offline:!1,message:"Duplicate sale blocked"};window.__quickSaleLock||(window.__quickSaleLock={}),window.__quickSaleLock[c]=Date.now();const f=async P=>{if(t.vehicleId)for(const L of t.lines)await ne._updateLocalInventory(t.vehicleId,[{productId:L.productId,productName:L.productName,quantity:L.quantity}],"subtract")};!1&&(!u()||await T());const A=U(),V=`INV-${Math.random().toString(36).substr(2,6).toUpperCase()}`,$=e==="return"||t.paymentMethod==="RETURN",B=$?"RETURN_SALE":"INVOICE_SALE",_={id:A,number:V,date:J(),type:B,...t,status:"POSTED"};await n.saveInvoice(_),t.vehicleId?await n.addToPendingSync("van_sale","CREATE",{id:A,vehicleId:t.vehicleId,customerId:t.partnerId,customerName:t.partnerName,items:t.lines.map(P=>({productId:P.productId,productName:P.productName,quantity:P.quantity,price:P.price})),paymentMethod:t.paymentMethod||"CASH",paymentCollected:t.paidAmount||0,discount:t.discount||0,total:t.total,date:J(),isReturn:$,notes:t.notes,bankAccountId:t.bankAccountId,creditPaymentType:t.creditPaymentType}):await n.addToPendingSync("invoice","CREATE",_),await this.updateResult(e,"SALE",{invoiceId:A,invoiceAmount:t.total,paymentCollected:t.paidAmount||0,paymentMethod:t.paymentMethod}),await f(A);try{await n.updatePartnerBalance(t.partnerId,t.total,t.paidAmount||0)}catch{}return r(),{success:!0,invoiceId:A,offline:!0,message:"تم حفظ الفاتورة محلياً"}}catch(i){throw r(),i}}},fe={async getAll(e){if(!u()){const t=e?`?vehicleId=${e}`:"",a=await l.get(`/vehicles/settlements${t}`);return Array.isArray(a)?a:[]}return await n.initialize(),await n.getSettlements(e)},async create(e){if(!u()||await T())try{return{success:!0,id:(await l.post("/vehicles/settlements",e)).id,offline:!1}}catch(s){if(!u())throw s}const t=U(),a={id:t,...e,status:"DRAFT"};return await n.saveSettlement(a),await n.addToPendingSync("vehicle_settlement","CREATE",a),{success:!0,id:t,offline:!0,message:"تم حفظ التسوية محلياً"}},async calculate(e,t,a){if(!u())return await l.get(`/vehicles/${e}/settlement-data?date=${t}`);await n.initialize();let s=null,r=!1;try{const w=(await n.getSettlements(e)).filter(v=>v.status==="APPROVED");if(w.length>0){r=!0;const v=w.reduce((h,C)=>{const R=new Date(C.approvedAt||C.updatedAt||C.createdAt||0),S=new Date(h.approvedAt||h.updatedAt||h.createdAt||0);return R>S?C:h});s=new Date(v.approvedAt||v.updatedAt||v.createdAt)}}catch{}const i=await n.getCustomerVisits({vehicleId:e,date:t}),c=s?i.filter(d=>new Date(d.visitDate||d.createdAt||0)>s):i,f=await n.getVehicleInventory(e);let I=0,A=0,q=0,V=0,$=0;for(const d of c)if(d.result==="SALE"&&d.invoiceAmount){const w=d.paymentMethod||"",v=w.toUpperCase(),h=v==="CASH"||v==="NAGDY"||w==="نقدي"||w==="نقداً"||w.includes("نقد"),C=v==="BANK"||w.includes("بنك"),R=v==="CREDIT"||w==="آجل"||w.includes("آجل");if(h){const S=d.paymentCollected||d.invoiceAmount||0;I+=S,V+=S;const o=(d.invoiceAmount||0)-S;o>0&&($+=o)}else if(C)q+=d.invoiceAmount;else if(R)A+=d.invoiceAmount,d.paymentCollected&&d.paymentCollected>0&&(V+=d.paymentCollected);else{const S=d.invoiceAmount||0,o=d.paymentCollected||0;o>=S&&S>0?(I+=S,V+=o):(A+=S,o>0&&(V+=o))}}let B=0,_=0,P=0,L=0,b=0,x=0;try{const v=(await n.getVehicles()).find(o=>String(o.id)===String(e))?.salesmanId,h=await n.getInvoices(),C=new Date(t);C.setHours(0,0,0,0);const R=new Date(t);R.setHours(23,59,59,999),h.length>0&&h.slice(0,3).forEach(y=>{});const S=h.filter(o=>{if(!o.date)return!1;const y=new Date(o.date);if(!(y>=C&&y<=R)||s&&y<=s)return!1;if(a){const O=String(o.createdBy||"").toLowerCase(),k=String(o.salesmanId||"").toLowerCase(),N=String(o.salesmanName||"").toLowerCase(),g=a.toLowerCase();if(!(!O&&!k&&!N||O===g||k===g||N===g||O.includes(g)||N.includes(g)))return!1}return!0});for(const o of S){const y=(o.type||"").toUpperCase(),E=o.paymentMethod||"",O=E.toUpperCase(),k=y.includes("SALE")&&!y.includes("RETURN"),N=y.includes("RETURN");if(k){const g=o.total||0,G=o.paidAmount??0,D=Number(o.discount||0)+Number(o.globalDiscount||0),ee=O==="CASH"||E==="نقدي"||E==="نقداً",te=O==="BANK"||E==="بنك"||E==="تحويل",ae=O==="CREDIT"||E==="آجل";if(D>0&&(x+=D),ee){const M=g-D;B+=M}else if(te){const M=g-D;P+=M}else if(ae){const M=g-D;_+=M,G>0&&(b+=G)}else{const M=g-D;_+=M}}else N&&(L+=o.total||0)}}catch{}const F=Math.max(I,B),H=Math.max(A,_),W=Math.max(q,P),X=Math.max($,x);let z=0;try{const d=await n.getInvoices({type:"RECEIPT"}),h=(await n.getVehicles()).find(o=>String(o.id)===String(e))?.salesmanId,C=new Date(t);C.setHours(0,0,0,0);const R=new Date(t);R.setHours(23,59,59,999);const S=d.filter(o=>{if(!o.date||o.referenceInvoiceId)return!1;const y=new Date(o.date);if(!(y>=C&&y<=R)||s&&y<=s)return!1;if(h){const O=String(o.salesmanId||""),k=String(o.createdBy||""),N=String(o.userId||""),g=String(h);return O===g||k===g||N===g}return!0});for(const o of S){const y=(o.paymentMethod||"").toUpperCase();if(!y||y==="CASH"){const E=o.paidAmount||o.total||0;z+=E}}}catch{}const K=z,Z=f.reduce((d,w)=>d+((w.quantity||0)*w.unitPrice||0),0);return{vehicleId:e,settlementDate:t,totalCashSales:F,totalCreditSales:H,totalSales:F+H+W,cashCollected:F+b,totalCollections:F+b,totalDebtCollected:K,closingInventoryValue:Z,expectedCash:F+b+K-L,actualCash:0,cashDifference:0,totalReturns:L,totalDiscounts:X}}},pe={async getAll(e){if(!u()){const t=new URLSearchParams;e?.vehicleId&&t.append("vehicleId",e.vehicleId),e?.salesmanId&&t.append("salesmanId",e.salesmanId),e?.date&&t.append("date",e.date);const a=await l.get(`/vehicles/routes?${t.toString()}`);return Array.isArray(a)?a:[]}return await n.initialize(),await n.getVehicleRoutes(e)},async get(e){if(!u())try{return await l.get(`/vehicles/routes/${e}`)}catch{return null}return await n.initialize(),await n.getVehicleRoute(e)},async create(e){if(!u()||await T())try{return{success:!0,id:(await l.post("/vehicles/routes",e)).id,offline:!1}}catch(s){if(!u())throw s}const t=U(),a={id:t,...e};return await n.saveVehicleRoute(a),await n.addToPendingSync("vehicle_route","CREATE",a),{success:!0,id:t,offline:!0,message:"تم حفظ خط السير محلياً"}},async start(e){const t={status:"IN_PROGRESS",startTime:new Date().toISOString()};if(!u()||await T())try{return await l.put(`/vehicles/routes/${e}/start`,{}),{success:!0,offline:!1}}catch(a){if(!u())throw a}return await n.updateVehicleRoute(e,t),await n.addToPendingSync("vehicle_route","START",{id:e,...t}),{success:!0,offline:!0}},async completeStop(e,t,a){if(!u()||await T())try{return await l.put(`/vehicles/routes/${e}/stops/${t}/complete`,a),{success:!0,offline:!1}}catch(s){if(!u())throw s}return await n.updateRouteStop(e,t,{status:"VISITED",...a}),await n.addToPendingSync("route_stop","COMPLETE",{routeId:e,stopId:t,...a}),{success:!0,offline:!0}},async complete(e){const t={status:"COMPLETED",endTime:new Date().toISOString()};if(!u()||await T())try{return await l.put(`/vehicles/routes/${e}/complete`,{}),{success:!0,offline:!1}}catch(a){if(!u())throw a}return await n.updateVehicleRoute(e,t),await n.addToPendingSync("vehicle_route","COMPLETE",{id:e,...t}),{success:!0,offline:!0}}},m=()=>Q.isNativePlatform(),Y=()=>`OFF_${Date.now().toString(36)}${Math.random().toString(36).slice(2,8)}`,j=()=>{try{const e=localStorage.getItem("currentUser");if(!e)return{salesmanId:null,isSalesman:!1};const t=JSON.parse(e);if(["ADMIN","admin","MANAGER","manager","GENERAL_MANAGER","المدير","المدير العام","مسئول النظام"].includes(t.role))return{salesmanId:null,isSalesman:!1};const r=["SALESMAN","salesman","SALES","sales","مبيعات","مندوب"].includes(t.role),i=!!t.vehicleId;return t.salesmanId?{salesmanId:t.salesmanId,isSalesman:!0}:r||i?{salesmanId:t.id,isSalesman:!0}:{salesmanId:null,isSalesman:!1}}catch{return{salesmanId:null,isSalesman:!1}}},p={invoice:(e,t=!1)=>({id:e.id,type:e.type,partnerId:e.partnerId,partnerName:e.partnerName||"",date:e.date,dueDate:e.dueDate,total:parseFloat(e.total)||0,paidAmount:parseFloat(e.paidAmount)||0,status:e.status||"DRAFT",lines:e.lines||[],notes:e.notes,previousBalance:e.previousBalance!=null?parseFloat(e.previousBalance):void 0,newBalance:e.newBalance!=null?parseFloat(e.newBalance):void 0,updatedAt:e.updatedAt||new Date().toISOString(),syncedAt:t?new Date().toISOString():""}),product:(e,t=!1)=>({id:e.id,sku:e.sku||"",name:e.name,categoryId:e.categoryId,categoryName:e.categoryName,price:parseFloat(e.price)||0,cost:parseFloat(e.cost)||0,stock:parseFloat(e.stock)||0,minStock:e.minStock,unit:e.unit,barcode:e.barcode,image:e.image,isActive:e.isActive!==!1,updatedAt:e.updatedAt||new Date().toISOString(),syncedAt:t?new Date().toISOString():""}),partner:(e,t=!1)=>({id:e.id,code:e.code,name:e.name,phone:e.phone,address:e.address,type:e.type||"CUSTOMER",isCustomer:e.isCustomer||e.type==="CUSTOMER"||e.type==="BOTH",isSupplier:e.isSupplier||e.type==="SUPPLIER"||e.type==="BOTH",balance:parseFloat(e.balance)||0,creditLimit:e.creditLimit,priceListId:e.priceListId,salesmanId:e.salesmanId,updatedAt:e.updatedAt||new Date().toISOString(),syncedAt:t?new Date().toISOString():""})},re={async create(e){const t=await n.isOnline(),a=e.id||Y(),s={...e,id:a,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};if(t&&m())try{const i=(await l.syncTransaction({invoice:s})).invoiceId||a;return await n.saveInvoices([{...s,id:i}],new Date().toISOString()),{success:!0,id:i,offline:!1}}catch{return this.saveOffline(s)}else return m()?this.saveOffline(s):{success:!0,id:(await l.syncTransaction({invoice:s})).invoiceId||a,offline:!1}},async saveOffline(e){try{const t=await n.createInvoice(e);return{success:t.success,id:t.id,offline:!0,message:t.success?"تم حفظ الفاتورة محلياً. ستتم المزامنة عند الاتصال بالإنترنت.":"فشل حفظ الفاتورة محلياً"}}catch(t){return{success:!1,id:e.id,offline:!0,message:`فشل الحفظ: ${t.message}`}}},async getAll(e){const{salesmanId:t,isSalesman:a}=j();if(!m()){let c=(await l.getInvoices({limit:e?.limit||100})).invoices.map(f=>p.invoice(f,!0));return a&&t&&(c=c.filter(f=>f.salesmanId===t)),c}const s=await n.getInvoices();let r=s;return a&&t&&(r=s.filter(i=>i.salesmanId===t||i.createdBy===t)),e?.partnerId&&(r=r.filter(i=>i.partnerId===e.partnerId)),e?.limit&&(r=r.slice(0,e.limit)),r.map(i=>p.invoice(i,!!i.syncedAt))},async get(e){if(!m()){const s=await l.getInvoice(e);return p.invoice(s,!0)}const a=(await n.getInvoices()).find(s=>s.id===e);return a?p.invoice(a,!!a.syncedAt):null},async update(e){const t=await n.isOnline();if(e.updatedAt=new Date().toISOString(),t&&m())try{return await l.syncTransaction({invoice:e}),await n.saveInvoices([e],new Date().toISOString()),{success:!0,offline:!1}}catch{return await n.saveInvoices([e],""),await n.addToPendingSync("invoice","UPDATE",e),{success:!0,offline:!0}}else return m()?(await n.saveInvoices([e],""),await n.addToPendingSync("invoice","UPDATE",e),{success:!0,offline:!0}):(await l.syncTransaction({invoice:e}),{success:!0,offline:!1})},async delete(e){const t=await n.isOnline(),a=JSON.parse(localStorage.getItem("currentUser")||"{}").name||"System";if(t&&m())try{return await l.syncTransaction({deletedInvoiceId:e,user:a}),{success:!0,offline:!1}}catch{return await n.addToPendingSync("invoice","DELETE",{id:e,user:a}),{success:!0,offline:!0}}else return m()?(await n.addToPendingSync("invoice","DELETE",{id:e,user:a}),{success:!0,offline:!0}):(await l.syncTransaction({deletedInvoiceId:e,user:a}),{success:!0,offline:!1})},async getPendingCount(){return m()?await n.getPendingCount():0}},ie={async getAll(){return m()?(await n.getProducts()).map(t=>p.product(t,!0)):(await l.getProducts()).map(a=>p.product(a,!0))},async search(e,t=50){return m()?(await n.searchProducts(e,t)).map(s=>p.product(s,!0)):(await l.getProductsPaginated(1,t,e)).products.map(r=>p.product(r,!0))},async get(e){if(!m()){const s=await l.getProduct(e);return p.product(s,!0)}const a=(await n.getProducts()).find(s=>s.id===e);return a?p.product(a,!0):null},async getByBarcode(e){if(!m())try{const s=await l.getUnitByBarcode(e);return p.product(s,!0)}catch{return null}const a=(await n.getProducts()).find(s=>s.barcode===e);return a?p.product(a,!0):null}},ce={async getAll(e){const{salesmanId:t,isSalesman:a}=j();if(!m()){let c=(await l.getPartners({limit:1e3,type:e})).partners.map(f=>p.partner(f,!0));if(a&&t&&e==="CUSTOMER"){const f=String(t),I=c.filter(A=>A.salesmanId&&String(A.salesmanId)===f);return I.length>0?I:c}return c}const s=await n.getPartners();let r=s;if(e==="CUSTOMER"?r=s.filter(i=>i.isCustomer):e==="SUPPLIER"&&(r=s.filter(i=>i.isSupplier)),a&&t&&e==="CUSTOMER"){const i=String(t),c=r.filter(f=>{const I=f.salesmanId;return I&&String(I)===i});if(c.length>0)return c.map(f=>p.partner(f,!0))}return r.map(i=>p.partner(i,!0))},async search(e,t,a=50){if(!m())return(await l.getPartners({limit:a,search:e,type:t})).partners.map(f=>p.partner(f,!0));const s=await n.getPartners(),r=e.toLowerCase();let i=s.filter(c=>c.name.toLowerCase().includes(r)||c.phone&&c.phone.includes(e)||c.code&&c.code.toLowerCase().includes(r));return t==="CUSTOMER"?i=i.filter(c=>c.isCustomer):t==="SUPPLIER"&&(i=i.filter(c=>c.isSupplier)),i.slice(0,a).map(c=>p.partner(c,!0))},async get(e){if(!m()){const s=await l.getPartners({limit:1,search:e});return s.partners.length>0?p.partner(s.partners[0],!0):null}const a=(await n.getPartners()).find(s=>s.id===e);return a?p.partner(a,!0):null},async create(e){const t=await n.isOnline(),a=e.id||Y(),s={...e,id:a};if(t&&m())try{const r=await l.createPartner(s);return await n.savePartners([r],new Date().toISOString()),{success:!0,id:r.id,offline:!1}}catch{return await n.savePartners([s],""),await n.addToPendingSync("partner","CREATE",s),{success:!0,id:a,offline:!0}}else return m()?(await n.savePartners([s],""),await n.addToPendingSync("partner","CREATE",s),{success:!0,id:a,offline:!0}):{success:!0,id:(await l.createPartner(s)).id,offline:!1}}},oe={async getStatus(){const e=await n.getStats(),t=await n.getPendingCount();return{isOnline:await n.isOnline(),pendingCount:t,lastSync:e.lastSync,stats:{products:e.products,partners:e.partners,invoices:e.invoices}}},async fullSync(){const e=await n.downloadAllData();return{success:e.success,message:e.message}},async deltaSync(){const e=await n.downloadAllData();return{success:e.success,message:e.message}},async syncPending(){return await n.syncPendingOperations()},async getPendingOperations(){return await n.getPendingOperations()},onSyncEvent(e){return()=>{}}},me={invoice:re,product:ie,partner:ce,sync:oe};export{me as a,ne as b,de as c,fe as d,pe as o};
